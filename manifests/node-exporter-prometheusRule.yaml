apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    app.kubernetes.io/component: exporter
    app.kubernetes.io/name: node-exporter
    app.kubernetes.io/part-of: kube-prometheus
    app.kubernetes.io/version: 1.2.2
    prometheus: node
    role: alert-rules
  name: node-exporter-rules
  namespace: monitoring
spec:
  groups:
  - name: node-exporter
    rules:
    - alert: NodeFilesystemSpaceFillingUp
      annotations:
        description: Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only {{ printf "%.2f" $value }}% available space left and is filling up.
        summary: Filesystem is predicted to run out of space within the next 24 hours.
      expr: |
        (
          node_filesystem_avail_bytes{job="node-exporter",fstype!="",mountpoint!="/data"} / node_filesystem_size_bytes{job="node-exporter",fstype!=""} * 100 < 40
        and
          predict_linear(node_filesystem_avail_bytes{job="node-exporter",fstype!=""}[6h], 24*60*60) < 0
        and
          node_filesystem_readonly{job="node-exporter",fstype!=""} == 0
        )
      for: 1h
      labels:
        severity: warning
    - alert: NodeFilesystemSpaceFillingUp
      annotations:
        description: Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only {{ printf "%.2f" $value }}% available space left and is filling up fast.
        summary: Filesystem is predicted to run out of space within the next 4 hours.
      expr: |
        (
          node_filesystem_avail_bytes{job="node-exporter",fstype!="",mountpoint!="/data"} / node_filesystem_size_bytes{job="node-exporter",fstype!=""} * 100 < 15
        and
          predict_linear(node_filesystem_avail_bytes{job="node-exporter",fstype!=""}[6h], 4*60*60) < 0
        and
          node_filesystem_readonly{job="node-exporter",fstype!=""} == 0
        )
      for: 1h
      labels:
        severity: critical
    - alert: NodeFilesystemAlmostOutOfSpace
      annotations:
        description: Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only {{ printf "%.2f" $value }}% available space left.
        summary: Filesystem has less than 5% space left.
      expr: |
        (
          node_filesystem_avail_bytes{job="node-exporter",fstype!="",mountpoint!="/data"} / node_filesystem_size_bytes{job="node-exporter",fstype!=""} * 100 < 5
        and
          node_filesystem_readonly{job="node-exporter",fstype!=""} == 0
        )
      for: 30m
      labels:
        severity: warning
    - alert: NodeFilesystemAlmostOutOfSpace
      annotations:
        description: Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only {{ printf "%.2f" $value }}% available space left.
        summary: Filesystem has less than 3% space left.
      expr: |
        (
          node_filesystem_avail_bytes{job="node-exporter",fstype!="",mountpoint!="/data"} / node_filesystem_size_bytes{job="node-exporter",fstype!=""} * 100 < 3
        and
          node_filesystem_readonly{job="node-exporter",fstype!=""} == 0
        )
      for: 30m
      labels:
        severity: critical
    - alert: NodeFilesystemFilesFillingUp
      annotations:
        description: Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only {{ printf "%.2f" $value }}% available inodes left and is filling up.
        summary: Filesystem is predicted to run out of inodes within the next 24 hours.
      expr: |
        (
          node_filesystem_files_free{job="node-exporter",fstype!="",mountpoint!="/data"} / node_filesystem_files{job="node-exporter",fstype!=""} * 100 < 40
        and
          predict_linear(node_filesystem_files_free{job="node-exporter",fstype!=""}[6h], 24*60*60) < 0
        and
          node_filesystem_readonly{job="node-exporter",fstype!=""} == 0
        )
      for: 1h
      labels:
        severity: warning
    - alert: NodeFilesystemFilesFillingUp
      annotations:
        description: Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only {{ printf "%.2f" $value }}% available inodes left and is filling up fast.
        summary: Filesystem is predicted to run out of inodes within the next 4 hours.
      expr: |
        (
          node_filesystem_files_free{job="node-exporter",fstype!="",mountpoint!="/data"} / node_filesystem_files{job="node-exporter",fstype!=""} * 100 < 20
        and
          predict_linear(node_filesystem_files_free{job="node-exporter",fstype!=""}[6h], 4*60*60) < 0
        and
          node_filesystem_readonly{job="node-exporter",fstype!=""} == 0
        )
      for: 1h
      labels:
        severity: critical
    - alert: NodeFilesystemAlmostOutOfFiles
      annotations:
        description: Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only {{ printf "%.2f" $value }}% available inodes left.
        summary: Filesystem has less than 5% inodes left.
      expr: |
        (
          node_filesystem_files_free{job="node-exporter",fstype!="",mountpoint!="/data"} / node_filesystem_files{job="node-exporter",fstype!=""} * 100 < 5
        and
          node_filesystem_readonly{job="node-exporter",fstype!=""} == 0
        )
      for: 1h
      labels:
        severity: warning
    - alert: NodeFilesystemAlmostOutOfFiles
      annotations:
        description: Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only {{ printf "%.2f" $value }}% available inodes left.
        summary: Filesystem has less than 3% inodes left.
      expr: |
        (
          node_filesystem_files_free{job="node-exporter",fstype!="",mountpoint!="/data"} / node_filesystem_files{job="node-exporter",fstype!=""} * 100 < 3
        and
          node_filesystem_readonly{job="node-exporter",fstype!=""} == 0
        )
      for: 1h
      labels:
        severity: critical
    - alert: NodeNetworkReceiveErrs
      annotations:
        description: '{{ $labels.instance }} interface {{ $labels.device }} has encountered
          {{ printf "%.0f" $value }} receive errors in the last two minutes.'
        summary: Network interface is reporting many receive errors.
      expr: |
        increase(node_network_receive_errs_total[2m]) > 10
      for: 1h
      labels:
        severity: warning
    - alert: NodeNetworkTransmitErrs
      annotations:
        description: '{{ $labels.instance }} interface {{ $labels.device }} has encountered
          {{ printf "%.0f" $value }} transmit errors in the last two minutes.'
        summary: Network interface is reporting many transmit errors.
      expr: |
        increase(node_network_transmit_errs_total[2m]) > 10
      for: 1h
      labels:
        severity: warning
    - alert: NodeNetworkReceiveDrops
      annotations:
        description: '{{ $labels.instance }} interface {{ $labels.device }} has encountered
          {{ printf "%.0f" $value }} receive drops in the last two minutes.'
        summary: Network interface is reporting many receive errors.
      expr: |
        increase(node_network_receive_drop_total[2m]) > 10
      for: 1h
      labels:
        severity: warning
    - alert: NodeNetworkTransmitDrops
      annotations:
        description: '{{ $labels.instance }} interface {{ $labels.device }} has encountered
          {{ printf "%.0f" $value }} transmit drops in the last two minutes.'
        summary: Network interface is reporting many transmit errors.
      expr: |
        increase(node_network_transmit_drop_total[2m]) > 10
      for: 1h
      labels:
        severity: warning
    - alert: NodeHighNumberConntrackEntriesUsed
      annotations:
        description: '{{ $value | humanizePercentage }} of conntrack entries are used.'
        summary: Number of conntrack are getting close to the limit.
      expr: |
        (node_nf_conntrack_entries / node_nf_conntrack_entries_limit) > 0.75
      labels:
        severity: warning
    - alert: NodeTextFileCollectorScrapeError
      annotations:
        description: Node Exporter text file collector failed to scrape.
        summary: Node Exporter text file collector failed to scrape.
      expr: |
        node_textfile_scrape_error{job="node-exporter"} == 1
      labels:
        severity: warning
    - alert: NodeClockSkewDetected
      annotations:
        description: Clock on {{ $labels.instance }} is out of sync by more than 300s. Ensure NTP is configured correctly on this host.
        summary: Clock skew detected.
      expr: |
        (
          node_timex_offset_seconds > 0.05
        and
          deriv(node_timex_offset_seconds[5m]) >= 0
        )
        or
        (
          node_timex_offset_seconds < -0.05
        and
          deriv(node_timex_offset_seconds[5m]) <= 0
        )
      for: 10m
      labels:
        severity: warning
    - alert: NodeClockNotSynchronising
      annotations:
        description: Clock on {{ $labels.instance }} is not synchronising. Ensure NTP is configured on this host.
        summary: Clock not synchronising.
      expr: |
        min_over_time(node_timex_sync_status[5m]) == 0
        and
        node_timex_maxerror_seconds >= 16
      for: 10m
      labels:
        severity: warning
    - alert: NodeRAIDDegraded
      annotations:
        description: RAID array '{{ $labels.device }}' on {{ $labels.instance }} is in degraded state due to one or more disks failures. Number of spare drives is insufficient to fix issue automatically.
        summary: RAID Array is degraded
      expr: |
        node_md_disks_required - ignoring (state) (node_md_disks{state="active"}) > 0
      for: 15m
      labels:
        severity: critical
    - alert: NodeRAIDDiskFailure
      annotations:
        description: At least one device in RAID array on {{ $labels.instance }} failed. Array '{{ $labels.device }}' needs attention and possibly a disk swap.
        summary: Failed device in RAID array
      expr: |
        node_md_disks{state="failed"} > 0
      labels:
        severity: warning
    - alert: NodeFileDescriptorLimit
      annotations:
        description: File descriptors limit at {{ $labels.instance }} is currently at {{ printf "%.2f" $value }}%.
        summary: Kernel is predicted to exhaust file descriptors limit soon.
      expr: |
        (
          node_filefd_allocated{job="node-exporter"} * 100 / node_filefd_maximum{job="node-exporter"} > 70
        )
      for: 15m
      labels:
        severity: warning
    - alert: NodeFileDescriptorLimit
      annotations:
        description: File descriptors limit at {{ $labels.instance }} is currently at {{ printf "%.2f" $value }}%.
        summary: Kernel is predicted to exhaust file descriptors limit soon.
      expr: |
        (
          node_filefd_allocated{job="node-exporter"} * 100 / node_filefd_maximum{job="node-exporter"} > 90
        )
      for: 15m
      labels:
        severity: critical
    - alert: NodeNetworkConnectionDown
      annotations:
        description: Ethernet connection {{ $labels.device }} on {{ $labels.instance }}
          is down.
        summary: A network connection has failed. Check cables or networking equipment.
      expr: |
        node_network_up{instance=~".+-cvr-.+",device=~"eno1|eno2|enp.+0"} != 1 or
        node_network_up{instance=~".+-mon-.+",device=~"eno1|enp216.+"} != 1
      for: 10m
      labels:
        severity: critical
    - alert: NodeDataConnectionSpeedLow
      annotations:
        description: Bonded data connection on {{ $labels.instance }} has {{ $value }}
          Gbps whereas it should be 20 Gbps.
        summary: Data connection speed is low. That might mean a lost network connection
          or configuration error either side of the connection.
      expr: |
        node_network_speed_bytes{device="bond0"}*8/1000/1000/1000 != 20
      for: 10m
      labels:
        severity: critical
    - alert: NewSELEntryInLast24h
      annotations:
        description: BMC on {{ $labels.instance }} added a new {{ $labels.state }} event
          to SEL in the last 24h.
        summary: A hardware event happened and it should be checked via IPMI SEL.
      expr: |
        ipmi_sel_events_count_by_state - ipmi_sel_events_count_by_state offset 1d > 0
      for: 1m
      labels:
        severity: warning
    - alert: HardwareSensorNotOptimal
      annotations:
        description: Sensor {{ $labels.name }} on {{ $labels.instance }} is in status
          {{ $value }}.
        summary: Hardware sensor is not in optimal status. Hardware manuals should
          be consulted and required action must be taken.
      expr: |
        ipmi_sensor_state != 0
      for: 10m
      labels:
        severity: critical
    - alert: HardwareFanSpeedNotOptimal
      annotations:
        description: Fan speed for {{ $labels.name }} on {{ $labels.instance }} is
          {{ $value }} RPM.
        summary: Fan speed state is not optimal. This might indicate a hardware fault
          on fan or a cooling issue.
      expr: |
        ipmi_fan_speed_rpm and ipmi_fan_speed_state != 0
      for: 10m
      labels:
        severity: warning
    - alert: HardwareTemperatureNotOptimal
      annotations:
        description: Temperature for {{ $labels.name }} on {{ $labels.instance }} is
          {{ $value }} C.
        summary: Temperature is not optimal. This might indicate a cooling issue.
      expr: |
        ipmi_temperature_celsius and ipmi_temperature_state != 0
      for: 10m
      labels:
        severity: warning
    - alert: HardwareVoltageNotOptimal
      annotations:
        description: Voltage for {{ $labels.name }} on {{ $labels.instance }} is
          {{ $value }} V.
        summary: Voltage is not optimal. This might indicate a hardware fault
          on power supply.
      expr: |
        ipmi_voltage_volts and ipmi_voltage_state != 0
      for: 10m
      labels:
        severity: warning
    - alert: HardwareTemperatureMissing
      annotations:
        description: Temperature {{ $labels.name }} is missing on {{ $value }} instance(s).
        summary: Component(s) may have hardware problems. Hardware manuals should
          be consulted and required action must be taken.
      expr: |
        count(up{service="ipmi-exporter", instance=~".+cvr.+"})
        - ignoring(name) group_right
        count(ipmi_temperature_state{instance=~".+cvr.+"}) by (name) > 0
      for: 10m
      labels:
        severity: warning
    - alert: HardwareTemperatureMissing
      annotations:
        description: Hardware temperature metrics missing on {{ $labels.instance }}.
        summary: Component(s) may have hardware problems. Hardware manuals should
          be consulted and required action must be taken.
      expr: |
        avg(count(ipmi_temperature_state{instance=~".+cvr.+"}) by (instance))
        - ignoring(instance) group_right
        count(ipmi_temperature_state{instance=~".+cvr.+"}) by (instance) > 0
      for: 10m
      labels:
        severity: warning
    - alert: HardwareTemperatureMissing
      annotations:
        description: Temperature {{ $labels.name }} is missing on {{ $value }} instance(s).
        summary: Component(s) may have hardware problems. Hardware manuals should
          be consulted and required action must be taken.
      expr: |
        count(up{service="ipmi-exporter", instance=~".+mon.+"})
        - ignoring(name) group_right
        count(ipmi_temperature_state{instance=~".+mon.+"}) by (name) > 0
      for: 10m
      labels:
        severity: warning
    - alert: HardwareTemperatureMissing
      annotations:
        description: Hardware temperature metrics missing on {{ $labels.instance }}.
        summary: Component(s) may have hardware problems. Hardware manuals should
          be consulted and required action must be taken.
      expr: |
        avg(count(ipmi_temperature_state{instance=~".+mon.+"}) by (instance))
        - ignoring(instance) group_right
        count(ipmi_temperature_state{instance=~".+mon.+"}) by (instance) > 0
      for: 10m
      labels:
        severity: warning
    - alert: HardwareFanMissing
      annotations:
        description: Fan {{ $labels.name }} is missing on {{ $value }} instance(s).
        summary: Component(s) may have hardware problems. Hardware manuals should
          be consulted and required action must be taken.
      expr: |
        count(up{service="ipmi-exporter", instance=~".+cvr.+"})
        - ignoring(name) group_right
        count(ipmi_fan_speed_state{instance=~".+cvr.+"}) by (name) > 0
      for: 10m
      labels:
        severity: warning
    - alert: HardwareFanMissing
      annotations:
        description: Hardware fan metrics missing on {{ $labels.instance }}.
        summary: Component(s) may have hardware problems. Hardware manuals should
          be consulted and required action must be taken.
      expr: |
        avg(count(ipmi_fan_speed_state{instance=~".+cvr.+"}) by (instance))
        - ignoring(instance) group_right
        count(ipmi_fan_speed_state{instance=~".+cvr.+"}) by (instance) > 0
      for: 10m
      labels:
        severity: warning
    - alert: HardwareFanMissing
      annotations:
        description: Fan {{ $labels.name }} is missing on {{ $value }} instance(s).
        summary: Component(s) may have hardware problems. Hardware manuals should
          be consulted and required action must be taken.
      expr: |
        count(up{service="ipmi-exporter", instance=~".+mon.+"})
        - ignoring(name) group_right
        count(ipmi_fan_speed_state{instance=~".+mon.+"}) by (name) > 0
      for: 10m
      labels:
        severity: warning
    - alert: HardwareFanMissing
      annotations:
        description: Hardware fan metrics missing on {{ $labels.instance }}.
        summary: Component(s) may have hardware problems. Hardware manuals should
          be consulted and required action must be taken.
      expr: |
        avg(count(ipmi_fan_speed_state{instance=~".+mon.+"}) by (instance))
        - ignoring(instance) group_right
        count(ipmi_fan_speed_state{instance=~".+mon.+"}) by (instance) > 0
      for: 10m
      labels:
        severity: warning
    - alert: WatchdogStopped
      annotations:
        description: BMC Watchdog stopped on {{ $labels.instance }}.
        summary: Watchdog timer is currently inactive. Ensure bmc-watchdog- services
          are working properly.
      expr: |
        ipmi_bmc_watchdog_timer_state != 1
      for: 10m
      labels:
        severity: warning
    - alert: WatchdogMisconfigured
      annotations:
        description: BMC Watchdog misconfigured on {{ $labels.instance }}.
        summary: Watchdog configuration is not what it's supposed to be. Ensure
          bmc-watchdog- services are working properly.
      expr: |
        ipmi_bmc_watchdog_initial_countdown_seconds != 600
        or ipmi_bmc_watchdog_logging_state != 1
        or ipmi_bmc_watchdog_timeout_action_state{action="Power Cycle"} != 1
        or ipmi_bmc_watchdog_timer_use_state{name="BIOS FRB2"} != 1
      for: 10m
      labels:
        severity: warning
    - alert: WatchdogCountdownLow
      annotations:
        description: BMC Watchdog timer not resetting on {{ $labels.instance }}.
        summary: Node is unable to reset the watchdog timer and it will expire in
          in {{ $value }} seconds.
      expr: |
        ipmi_bmc_watchdog_current_countdown_seconds < 480
      for: 2m
      labels:
        severity: warning
    - alert: RAIDControllerUnhealthy
      annotations:
        description: RAID Controller {{ $labels.controller }}
          on {{ $labels.instance }} is not healthy.
        summary: RAID Controller is in unhealthy condition. Please consult hardware manuals.
      expr: |
        megaraid_healthy != 1
      for: 10m
      labels:
        severity: critical
    - alert: RAIDControllerFailed
      annotations:
        description: RAID Controller {{ $labels.controller }}
          on {{ $labels.instance }} has failed.
        summary: RAID Controller has failed. Please consult hardware manuals.
      expr: |
        megaraid_failed != 0
      for: 10m
      labels:
        severity: critical
    - alert: RAIDControllerCannotReachDrive
      annotations:
        description: RAID Controller on {{ $labels.instance }} can only reach {{ $value }}/36 drives.
        summary: This node has a failed drive and it needs to be replaced.
      expr: |
        count(megaraid_pd_media_errors) by (instance) < 36
      for: 10m
      labels:
        severity: warning
    - alert: DriveSlotNotOK
      annotations:
        description: SAS Slot {{ $labels.description }}({{ $labels.index}})
          on {{ $labels.device }} of {{ $labels.instance }} not OK.
        summary: SAS Drive slot is reported not OK. This might mean drive
          has failed and needs replacing.
      expr: |
        ses_array_device_slot_ok != 1
      for: 10m
      labels:
        severity: critical
    - alert: DriveSlotFaultReqstd
      annotations:
        description: SAS Slot {{ $labels.description }}({{ $labels.index}})
          on {{ $labels.device }} of {{ $labels.instance }} has RQST FAULT.
        summary: SAS Drive slot is reported with Fault reqstd. This might
          mean drive has failed and needs replacing.
      expr: |
        ses_array_device_slot_fault_reqstd != 0
      for: 10m
      labels:
        severity: critical
    - alert: DriveSlotIndicatorLit
      annotations:
        description: SAS Slot {{ $labels.description }}({{ $labels.index}})
          on {{ $labels.device }} of {{ $labels.instance }} has its indicator
          LED lit.
        summary: SAS Drive indicator LED is lit. This might mean a fault
          or an undergoing maintenance.
      expr: |
        ses_array_device_slot_ident != 0
      for: 1m
      labels:
        severity: warning
    - alert: MemoryMissing
      annotations:
        description: Instance {{ $labels.instance }} is missing ~ {{ printf "%.2f" $value }}
          Gi of RAM.
        summary: Node probably has a faulty memory module. Please consult hardware manuals
          and replace if necessary.
      expr: |
        (max(node_memory_MemTotal_bytes{instance=~".+cvr.+"}) without(instance,pod)
        - ignoring(instance, pod) group_right
        node_memory_MemTotal_bytes{instance=~".+cvr.+"}) /1024/1024/1024 > 1
      for: 10m
      labels:
        severity: warning
    - alert: MemoryMissing
      annotations:
        description: Instance {{ $labels.instance }} is missing ~ {{ printf "%.2f" $value }}
          Gi of RAM.
        summary: Node probably has a faulty memory module. Please consult hardware manuals
          and replace if necessary.
      expr: |
        (max(node_memory_MemTotal_bytes{instance=~".+mon.+"}) without(instance,pod)
        - ignoring(instance, pod) group_right
        node_memory_MemTotal_bytes{instance=~".+mon.+"}) /1024/1024/1024 > 1
      for: 10m
      labels:
        severity: warning
  - name: node-exporter.rules
    rules:
    - expr: |
        avg without (pod, instance, cpu) (
          irate(node_cpu_seconds_total{instance=~".+-cvr-[0-9]+"}[5m])
        )
      record: mode:node_cpu_seconds:avg_irate5m_cvr
    - expr: |
        avg without (pod, instance, cpu) (
          irate(node_cpu_seconds_total{instance=~".+-mon-[0-9]+"}[5m])
        )
      record: mode:node_cpu_seconds:avg_irate5m_mon
    - expr: |
        count without (cpu) (
          count without (mode) (
            node_cpu_seconds_total{job="node-exporter"}
          )
        )
      record: instance:node_num_cpu:sum
    - expr: |
        1 - avg without (cpu, mode) (
          rate(node_cpu_seconds_total{job="node-exporter", mode="idle"}[5m])
        )
      record: instance:node_cpu_utilisation:rate5m
    - expr: |
        (
          node_load1{job="node-exporter"}
        /
          instance:node_num_cpu:sum{job="node-exporter"}
        )
      record: instance:node_load1_per_cpu:ratio
    - expr: |
        1 - (
          node_memory_MemAvailable_bytes{job="node-exporter"}
        /
          node_memory_MemTotal_bytes{job="node-exporter"}
        )
      record: instance:node_memory_utilisation:ratio
    - expr: |
        rate(node_vmstat_pgmajfault{job="node-exporter"}[5m])
      record: instance:node_vmstat_pgmajfault:rate5m
    - expr: |
        rate(node_disk_io_time_seconds_total{job="node-exporter", device=~"mmcblk.p.+|nvme.+|rbd.+|sd.+|vd.+|xvd.+|dm-.+|dasd.+"}[5m])
      record: instance_device:node_disk_io_time_seconds:rate5m
    - expr: |
        rate(node_disk_io_time_weighted_seconds_total{job="node-exporter", device=~"mmcblk.p.+|nvme.+|rbd.+|sd.+|vd.+|xvd.+|dm-.+|dasd.+"}[5m])
      record: instance_device:node_disk_io_time_weighted_seconds:rate5m
    - expr: |
        sum without (device) (
          rate(node_network_receive_bytes_total{job="node-exporter", device!="lo"}[5m])
        )
      record: instance:node_network_receive_bytes_excluding_lo:rate5m
    - expr: |
        sum without (device) (
          rate(node_network_transmit_bytes_total{job="node-exporter", device!="lo"}[5m])
        )
      record: instance:node_network_transmit_bytes_excluding_lo:rate5m
    - expr: |
        sum without (device) (
          rate(node_network_receive_drop_total{job="node-exporter", device!="lo"}[5m])
        )
      record: instance:node_network_receive_drop_excluding_lo:rate5m
    - expr: |
        sum without (device) (
          rate(node_network_transmit_drop_total{job="node-exporter", device!="lo"}[5m])
        )
      record: instance:node_network_transmit_drop_excluding_lo:rate5m
